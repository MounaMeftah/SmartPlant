<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ Test Firebase - SmartPlant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f1f5f9;
            padding: 40px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(30, 41, 59, 0.7);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        h1 { 
            font-size: 36px; 
            margin-bottom: 10px;
            color: #10b981;
        }
        .subtitle {
            color: #94a3b8;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 16px;
        }
        .status-success { background: rgba(16, 185, 129, 0.1); border-left: 4px solid #10b981; }
        .status-warning { background: rgba(245, 158, 11, 0.1); border-left: 4px solid #f59e0b; }
        .status-error { background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; }
        .status-info { background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; }
        .icon { font-size: 24px; }
        .data-card {
            background: rgba(16, 185, 129, 0.05);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .data-row:last-child { border-bottom: none; }
        .data-label { color: #94a3b8; }
        .data-value { 
            color: #10b981; 
            font-weight: bold; 
            font-size: 18px;
        }
        pre {
            background: #1e293b;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            color: #10b981;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #10b981;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        button {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        button:hover {
            background: #059669;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Test de Connexion Firebase</h1>
        <p class="subtitle">Diagnostic complet de votre configuration SmartPlant</p>

        <!-- Statut de connexion -->
        <div id="connectionStatus">
            <div class="status status-info">
                <span class="icon">‚è≥</span>
                <div>
                    <strong>Connexion en cours...</strong>
                    <div class="loading" style="margin-top: 5px;"></div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div style="margin: 20px 0;">
            <button onclick="forceRefresh()">üîÑ Rafra√Æchir</button>
            <button onclick="testWrite()">‚úèÔ∏è Test √âcriture</button>
            <button onclick="window.location.href='index.html'">üè† Retour Dashboard</button>
        </div>

        <!-- Donn√©es capteurs -->
        <h2 style="margin: 30px 0 15px;">üìä Donn√©es des Capteurs</h2>
        <div class="data-card" id="sensorsData">
            <div class="data-row">
                <span class="data-label">üå°Ô∏è Temp√©rature</span>
                <span class="data-value" id="temp">--</span>
            </div>
            <div class="data-row">
                <span class="data-label">üíß Humidit√© Sol</span>
                <span class="data-value" id="soil">--</span>
            </div>
            <div class="data-row">
                <span class="data-label">üí® Humidit√© Air</span>
                <span class="data-value" id="air">--</span>
            </div>
            <div class="data-row">
                <span class="data-label">üåßÔ∏è Pluie</span>
                <span class="data-value" id="rain">--</span>
            </div>
            <div class="data-row">
                <span class="data-label">‚è±Ô∏è Timestamp</span>
                <span class="data-value" id="timestamp">--</span>
            </div>
        </div>

        <!-- Configuration -->
        <h2 style="margin: 30px 0 15px;">‚öôÔ∏è Configuration</h2>
        <div class="data-card" id="configData">
            <div class="data-row">
                <span class="data-label">Seuil Bas</span>
                <span class="data-value" id="seuilBas">--</span>
            </div>
            <div class="data-row">
                <span class="data-label">Seuil Haut</span>
                <span class="data-value" id="seuilHaut">--</span>
            </div>
            <div class="data-row">
                <span class="data-label">Mode</span>
                <span class="data-value" id="mode">--</span>
            </div>
        </div>

        <!-- Donn√©es brutes JSON -->
        <h2 style="margin: 30px 0 15px;">üîç Donn√©es Brutes (JSON)</h2>
        <pre id="rawData">Chargement...</pre>

        <!-- Console de logs -->
        <h2 style="margin: 30px 0 15px;">üìù Console de Logs</h2>
        <div style="background: #1e293b; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
            <div id="logs" style="font-family: monospace; font-size: 12px; color: #10b981;"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBXj4K3rT2qLm8vN9wP5xH7yC6kR1mE4fU",
            authDomain: "smartpant-4bc8f.firebaseapp.com",
            databaseURL: "https://smartpant-4bc8f-default-rtdb.firebaseio.com",
            projectId: "smartpant-4bc8f",
            storageBucket: "smartpant-4bc8f.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456"
        };

        let database;
        let firebaseData = {};

        // Fonction de log
        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const time = new Date().toLocaleTimeString('fr-FR');
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            const color = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6';
            logsDiv.innerHTML += `<div style="color: ${color}; margin-bottom: 5px;">[${time}] ${icon} ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        // Initialiser Firebase
        function initFirebase() {
            try {
                addLog('üî• Initialisation Firebase...', 'info');
                
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                database = firebase.database();
                addLog('‚úÖ Firebase initialis√©', 'success');

                // √âcouter les donn√©es
                database.ref('/').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        firebaseData = data;
                        addLog('üì° Donn√©es re√ßues de Firebase', 'success');
                        updateUI(data);
                    } else {
                        addLog('‚ö†Ô∏è Aucune donn√©e dans Firebase', 'warning');
                    }
                }, (error) => {
                    addLog(`‚ùå Erreur lecture: ${error.message}`, 'error');
                    updateConnectionStatus(false, error.message);
                });

                // V√©rifier connexion
                database.ref('.info/connected').on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        addLog('‚úÖ Connect√© √† Firebase !', 'success');
                        updateConnectionStatus(true);
                    } else {
                        addLog('‚ö†Ô∏è D√©connect√© de Firebase', 'warning');
                        updateConnectionStatus(false, 'D√©connect√©');
                    }
                });

            } catch (error) {
                addLog(`‚ùå Erreur init: ${error.message}`, 'error');
                updateConnectionStatus(false, error.message);
            }
        }

        // Mettre √† jour le statut de connexion
        function updateConnectionStatus(connected, errorMsg = '') {
            const statusDiv = document.getElementById('connectionStatus');
            if (connected) {
                statusDiv.innerHTML = `
                    <div class="status status-success">
                        <span class="icon">‚úÖ</span>
                        <div>
                            <strong>Connect√© √† Firebase !</strong>
                            <p style="margin-top: 5px; font-size: 14px; color: #94a3b8;">
                                Database: ${firebaseConfig.databaseURL.replace('https://', '').replace('.firebaseio.com', '')}
                            </p>
                        </div>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="status status-error">
                        <span class="icon">‚ùå</span>
                        <div>
                            <strong>Erreur de connexion</strong>
                            <p style="margin-top: 5px; font-size: 14px; color: #94a3b8;">
                                ${errorMsg || 'Impossible de se connecter √† Firebase'}
                            </p>
                        </div>
                    </div>
                `;
            }
        }

        // Mettre √† jour l'interface
        function updateUI(data) {
            // Capteurs
            if (data.capteurs) {
                document.getElementById('temp').textContent = (data.capteurs.temperature || 0) + ' ¬∞C';
                document.getElementById('soil').textContent = (data.capteurs.humiditeSol || 0) + ' %';
                document.getElementById('air').textContent = (data.capteurs.humiditeAir || 0) + ' %';
                document.getElementById('rain').textContent = (data.capteurs.pluie || 0) + ' %';
                document.getElementById('timestamp').textContent = data.capteurs.timestamp || 0;
            }

            // Configuration
            if (data.configuration) {
                document.getElementById('seuilBas').textContent = (data.configuration.seuilHumiditeBas || 0) + ' %';
                document.getElementById('seuilHaut').textContent = (data.configuration.seuilHumiditeHaut || 0) + ' %';
                document.getElementById('mode').textContent = data.configuration.mode || 'N/A';
            }

            // Donn√©es brutes
            document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);
        }

        // Forcer le rafra√Æchissement
        function forceRefresh() {
            addLog('üîÑ Rafra√Æchissement forc√©...', 'info');
            if (database) {
                database.ref('/').once('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        firebaseData = data;
                        updateUI(data);
                        addLog('‚úÖ Donn√©es rafra√Æchies', 'success');
                    }
                });
            }
        }

        // Test d'√©criture
        function testWrite() {
            if (!database) {
                addLog('‚ùå Firebase non initialis√©', 'error');
                return;
            }

            addLog('‚úèÔ∏è Test d\'√©criture dans Firebase...', 'info');
            const testValue = Math.floor(Math.random() * 100);
            
            database.ref('/test').set({
                value: testValue,
                timestamp: Date.now()
            }).then(() => {
                addLog(`‚úÖ √âcriture r√©ussie ! Valeur: ${testValue}`, 'success');
            }).catch(error => {
                addLog(`‚ùå Erreur √©criture: ${error.message}`, 'error');
            });
        }

        // D√©marrer au chargement
        window.addEventListener('DOMContentLoaded', () => {
            addLog('üåø SmartPlant Test - D√©marrage...', 'info');
            initFirebase();
        });
    </script>
</body>
</html>